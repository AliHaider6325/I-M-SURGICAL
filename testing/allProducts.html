<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Manage Products</title>
    <style>
      body {
        font-family: sans-serif;
        max-width: 800px;
        margin: 40px auto;
        background: #f8f9fa;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      }
      h2 {
        text-align: center;
        color: #333;
      }
      input, button {
        width: 100%;
        margin: 8px 0;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #ccc;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }
      table {
        width: 100%;
        margin-top: 20px;
        border-collapse: collapse;
        background: white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        border-radius: 8px;
        overflow: hidden;
      }
      th, td {
        padding: 10px;
        border-bottom: 1px solid #ddd;
        text-align: left;
      }
      th {
        background: #007bff;
        color: white;
      }
      tr:hover {
        background: #f1f1f1;
      }
      .delete-btn {
        background: #dc3545;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 5px;
        cursor: pointer;
      }
      .delete-btn:hover {
        background: #b52b36;
      }
      img {
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <h2>Upload Product</h2>
    <form id="productForm" enctype="multipart/form-data">
      <input type="text" name="title" placeholder="Product Title" required />
      <input type="number" name="price" placeholder="Price" required />
      <input type="text" name="category" placeholder="Category ID" required />
      <input type="number" name="stock" placeholder="Stock Quantity" />
      <input type="file" name="images" multiple />
      <button type="submit">Upload</button>
    </form>

    <h2>All Products</h2>
    <table id="products-table">
      <thead>
        <tr>
          <th>Title</th>
          <th>Price</th>
          <th>Category</th>
          <th>Stock</th>
          <th>Image</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="products-body">
        <tr><td colspan="6" style="text-align:center;">Loading...</td></tr>
      </tbody>
    </table>

    <script>
      const API_URL = "http://localhost:5000/api/products";

      // ‚úÖ Get token safely
      function getToken() {
        const token = localStorage.getItem("token");
        if (!token) {
          alert("Unauthorized! Please log in.");
          window.location.href = "login.html";
          return null;
        }
        return token;
      }

      // ‚úÖ Universal fetch with JWT + expiry handling
      async function fetchWithAuth(url, options = {}) {
        const token = getToken();
        if (!token) return;

        const res = await fetch(url, {
          ...options,
          headers: {
            Authorization: `Bearer ${token}`,
            ...options.headers,
          },
        });

        if (res.status === 401) {
          const data = await res.json().catch(() => ({}));
          if (data.message && data.message.toLowerCase().includes("expired")) {
            alert("Session expired. Please log in again.");
            localStorage.removeItem("token");
            window.location.href = "login.html";
            return null;
          }
        }

        return res;
      }

      // üßæ Load products
      async function loadProducts() {
        const res = await fetchWithAuth(API_URL);
        if (!res) return;

        const data = await res.json();
        const tbody = document.getElementById("products-body");
        tbody.innerHTML = "";

        if (!data.products || data.products.length === 0) {
          tbody.innerHTML = "<tr><td colspan='6' style='text-align:center;'>No products found</td></tr>";
          return;
        }

        data.products.forEach(p => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${p.title}</td>
            <td>${p.price}</td>
            <td>${p.category}</td>
            <td>${p.stock || 0}</td>
            <td>${p.images && p.images.length ? `<img src="${p.images[0]}" width="60" />` : "-"}</td>
            <td><button class="delete-btn" onclick="deleteProduct('${p._id}', this)">Delete</button></td>
          `;
          tbody.appendChild(tr);
        });
      }

      // ‚ûï Upload product
      document.getElementById("productForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const token = getToken();
        if (!token) return;

        const formData = new FormData(e.target);

        const res = await fetchWithAuth(API_URL, {
          method: "POST",
          body: formData,
        });

        if (!res) return;

        const data = await res.json();
        if (data.success) {
          alert("‚úÖ Product added successfully!");
          e.target.reset();
          loadProducts();
        } else {
          alert("‚ùå Failed to add: " + (data.message || "Unknown error"));
        }
      });

      // ‚ùå Delete product
      async function deleteProduct(id, btn) {
        const confirmDel = confirm("Delete this product?");
        if (!confirmDel) return;

        const res = await fetchWithAuth(`${API_URL}/${id}`, { method: "DELETE" });
        if (!res) return;

        const data = await res.json();
        if (data.success) {
          btn.closest("tr").remove();
          alert("üóëÔ∏è Product deleted successfully");
        } else {
          alert("‚ùå Failed to delete: " + (data.message || "Unknown error"));
        }
      }

      loadProducts();
    </script>
  </body>
</html>
